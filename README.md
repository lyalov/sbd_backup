
Домашнее задание к занятию «Резервное копирование баз данных»
Ялова Л.В.

Задание 1. Резервное копирование
Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.
Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.

ОТВЕТ 1

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.
Для данного сценария подходит полное (full) резервное копирование, выполняемое ежедневно в ночное время (например, после окончания рабочего дня). Такой подход обеспечивает наличие актуальной копии всех данных на момент завершения предыдущего дня. Восстановление происходит из одного архива, что упрощает процесс и сокращает время восстановления 

Если объём данных велик и полное резервное копирование занимает много времени или ресурсов, можно использовать комбинацию полного и инкрементного/дифференциального резервного копирования. Однако для простоты и гарантированного восстановления состояния «на конец дня» чаще всего достаточно ежедневного full-бэкапа.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.
В этом случае требуется более частое и гранулярное резервное копирование. Подходящая стратегия — логическое (point-in-time) резервное копирование с использованием архивации журналов транзакций WAL в PostgreSQL, transaction logs в MS SQL Oracle и т.д.

Процесс:

Выполняется полное резервное копирование с определённой периодичностью ,например, раз в день.
Параллельно архивируются журналы тransакций с высокой частотой ,каждые несколько минут или раз в час .
При восстановлении сначала загружается последний полный бэкап, затем последовательно накатываются журналы транзакций до требуемой точки во времени ,например, за час до сбоя.
Это позволяет достичь точности восстановления с точностью до секунды, что критично для финансовых данных.

1.3. Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.
Да, такой сценарий возможен и реализуется с помощью репликации и отказоустойчивых кластеров.
Примеры решений:
Стриминговая репликация  или потоковая репликация  в PostgreSQL с использованием hot standby и автоматического переключения failover через менеджеры вроде Patroni или Corosync  repmgr или pg_auto_failover.
В других СУБД — Always On Availability Groups MSSQL, Data Guard (Oracle), Galera Cluster или Corosync (MySQL/MariaDB).

Основной сервер (primary/master) синхронно или асинхронно реплицирует данные на резервный (standby/replica).
В случае сбоя основного сервера система автоматически переключает трафик на резервный сервер (failover), обеспечивая минимальное время простоя (иногда менее секунды при синхронной репликации).
После восстановления основного сервера он может вернуться в кластер как реплика или быть переведён обратно в роль primary (в зависимости от политики).
Таким образом, моментальное переключение возможно, но требует соответствующей архитектуры, правильно настроенной репликации и механизма автоматического управления отказоустойчивостью.





Задание 2. PostgreSQL
2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).
2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?
Приведите ответ в свободной форме.

ОТВЕТ2
2.1. Пример команд резервного копирования и восстановления в PostgreSQL с использованием pg_dump , pg_restore
PostgreSQL предоставляет утилиты pg_dump для создания резервной копии и pg_restore для восстановления из копии в формате архива.
Резервное копирование создание дампа: ```bash pg_dump -h localhost -U username -F c -b -v -f backup_file.backup dbname  ``` 

2.1 Возможно ли автоматизировать этот процесс? Если да, то как?*
Через скрипт запуск которого регулируется через crontab
Пример простейшего скрипта выполнения бекапа бд  finance_db
```bash
#!/bin/bash
BACKUP_DIR="/var/backups/postgres"
DB_NAME="finance_db"
USER="postgres"
DATE=$(date +%Y%m%d_%H%M)
pg_dump -U $USER -F c -b -v -f "$BACKUP_DIR/${DB_NAME}_${DATE}.backup" $DB_NAME
# Удаление бэкапов старше 7 дней
find $BACKUP_DIR -name "${DB_NAME}*.backup" -mtime +7 -delete
```


Задание 3. MySQL
3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.
3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?
Приведите ответ в свободной форме.

ОТВЕТ 3 
3.1 С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.
Нужно включить бинарное логирование в конфигурации MySQL

Как работает инкрементное копирование в MySQL
Полная копия Full Backup: Создается первая, полная копия всей базы данных.
Инкрементные копии : Последующие бэкапы сохраняют только те данные, которые изменились с момента последней (полной или инкрементной) копии.
Восстановление: Для восстановления необходимо иметь последнюю полную копию и все последующие инкрементные копии в цепочке. 

Полный бекап : ```bash xtrabackup --user=root --password=(что то там) --backup --target-dir=/backup/full_20251216 ```
Инкрементный бэкап ``` bash xtrabackup --user=root --password=... --backup --target-dir=/backup/inc_20251216_1 --incremental-basedir=/backup/full_20251216 ```

